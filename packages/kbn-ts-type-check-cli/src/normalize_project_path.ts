/*
 * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
 * or more contributor license agreements. Licensed under the "Elastic License
 * 2.0", the "GNU Affero General Public License v3.0 only", and the "Server Side
 * Public License v 1"; you may not use this file except in compliance with, at
 * your election, the "Elastic License 2.0", the "GNU Affero General Public
 * License v3.0 only", or the "Server Side Public License, v 1".
 */

import Path from 'path';
import { REPO_ROOT } from '@kbn/repo-info';
import type { SomeDevLog } from '@kbn/some-dev-log';

const TYPE_CHECK_CONFIG_FILENAME = 'tsconfig.type_check.json';
const PROJECT_CONFIG_FILENAME = 'tsconfig.json';

const formatPathForLog = (path: string) => {
  if (!Path.isAbsolute(path)) {
    return path;
  }

  const relativeToRepoRoot = Path.relative(REPO_ROOT, path);
  if (!relativeToRepoRoot.startsWith('..') && !Path.isAbsolute(relativeToRepoRoot)) {
    return relativeToRepoRoot;
  }

  return path;
};

/**
 * Normalizes the `--project` value passed to `scripts/type_check`.
 *
 * The type-check CLI expects a source `tsconfig.json`. If a generated
 * `tsconfig.type_check.json` path is passed instead, this rewrites it to the
 * sibling `tsconfig.json` and logs a warning explaining the correction.
 */
export const normalizeProjectPath = (
  projectPath: string | undefined,
  log: Pick<SomeDevLog, 'warning'>
) => {
  if (!projectPath || Path.basename(projectPath) !== TYPE_CHECK_CONFIG_FILENAME) {
    return projectPath;
  }

  const normalizedPath = Path.resolve(Path.dirname(projectPath), PROJECT_CONFIG_FILENAME);
  const formattedProjectPath = formatPathForLog(projectPath);
  const formattedNormalizedPath = formatPathForLog(normalizedPath);

  log.warning(
    `Received --project=${formattedProjectPath}. ${TYPE_CHECK_CONFIG_FILENAME} is generated by the type-check script; using ${formattedNormalizedPath} instead.`
  );

  return normalizedPath;
};
