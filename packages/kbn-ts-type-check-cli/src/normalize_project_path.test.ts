/*
 * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
 * or more contributor license agreements. Licensed under the "Elastic License
 * 2.0", the "GNU Affero General Public License v3.0 only", and the "Server Side
 * Public License v 1"; you may not use this file except in compliance with, at
 * your election, the "Elastic License 2.0", the "GNU Affero General Public
 * License v3.0 only", or the "Server Side Public License, v 1".
 */

import Path from 'path';
import { REPO_ROOT } from '@kbn/repo-info';

import { normalizeProjectPath } from './normalize_project_path';

describe('normalizeProjectPath', () => {
  it('returns undefined when project path is not set', () => {
    const warning = jest.fn();
    expect(normalizeProjectPath(undefined, { warning })).toBeUndefined();
    expect(warning).not.toHaveBeenCalled();
  });

  it('returns the same project path when tsconfig.json is passed', () => {
    const warning = jest.fn();
    const projectPath = '/repo/packages/foo/tsconfig.json';

    expect(normalizeProjectPath(projectPath, { warning })).toBe(projectPath);
    expect(warning).not.toHaveBeenCalled();
  });

  it('normalizes tsconfig.type_check.json to tsconfig.json and logs a warning', () => {
    const warning = jest.fn();
    const projectPath = Path.resolve(REPO_ROOT, 'packages/foo/tsconfig.type_check.json');
    const normalizedProjectPath = Path.resolve(REPO_ROOT, 'packages/foo/tsconfig.json');

    expect(normalizeProjectPath(projectPath, { warning })).toBe(normalizedProjectPath);
    expect(warning).toHaveBeenCalledTimes(1);
    expect(warning).toHaveBeenCalledWith(
      `Received --project=packages/foo/tsconfig.type_check.json. tsconfig.type_check.json is generated by the type-check script; using packages/foo/tsconfig.json instead.`
    );
  });
});
