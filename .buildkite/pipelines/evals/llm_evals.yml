env:
  KBN_EVALS: '1'
steps:
  - label: 'üë®‚Äçüîß Pre-Build'
    command: .buildkite/scripts/lifecycle/pre_build.sh
    agents:
      image: family/kibana-ubuntu-2404
      imageProject: elastic-images-prod
      provider: gcp
      machineType: n2-standard-2

  - wait

  - label: 'Store Cache for build'
    command: .buildkite/scripts/steps/store_cache.sh
    timeout_in_minutes: 10
    id: store_cache
    soft_fail: true
    agents:
      image: family/kibana-ubuntu-2404
      imageProject: elastic-images-prod
      provider: gcp
      machineType: n2-highcpu-8
      diskSizeGb: 95

  - label: 'üßë‚Äçüè≠ Build Kibana Distribution'
    command: .buildkite/scripts/steps/build_kibana.sh
    agents:
      image: family/kibana-ubuntu-2404
      imageProject: elastic-images-prod
      provider: gcp
      machineType: n2-standard-8
    key: build
    if: "build.env('KIBANA_BUILD_ID') == null || build.env('KIBANA_BUILD_ID') == ''"

  - wait

  - group: 'LLM Evals (weekly)'
    key: llm-evals-weekly
    steps:
      - label: 'Evals: Agent Builder'
        key: kbn-evals-weekly-agent-builder
        command: bash .buildkite/scripts/steps/evals/run_suite.sh
        env:
          KBN_EVALS: '1'
          FTR_EIS_CCM: '1'
          EVAL_SUITE_ID: 'agent-builder'
          EVAL_FANOUT: '1'
          EVAL_INCLUDE_EIS_MODELS: '1'
          # Weekly pipeline model allowlist:
          # - Default behavior (EVAL_MODEL_GROUPS=all) runs against every discovered LiteLLM + EIS model.
          # - That is too expensive/noisy for a weekly cadence, so we currently pin to a small EIS allowlist.
          #
          # NOTE: Use `eis/<modelId>` values (not connector ids) so we can filter purely on the discovered
          # EIS model ids in `target/eis_models.json`.
          EVAL_MODEL_GROUPS: &weekly_eis_model_groups 'eis/anthropic-claude-4.5-sonnet,eis/anthropic-claude-4.6-opus,eis/google-gemini-3.0-flash,eis/google-gemini-3.0-pro,eis/openai-gpt-5.2,eis/openai-gpt-oss-120b'
        timeout_in_minutes: 60
        agents:
          image: family/kibana-ubuntu-2404
          imageProject: elastic-images-prod
          provider: gcp
          machineType: n2-standard-8
          preemptible: true
        retry:
          automatic:
            - exit_status: '-1'
              limit: 3

      - label: 'Evals: ES|QL Generation Evaluations'
        key: kbn-evals-weekly-esql-generation
        command: bash .buildkite/scripts/steps/evals/run_suite.sh
        env:
          KBN_EVALS: '1'
          FTR_EIS_CCM: '1'
          EVAL_SUITE_ID: 'esql-generation'
          EVAL_FANOUT: '1'
          EVAL_INCLUDE_EIS_MODELS: '1'
          EVAL_MODEL_GROUPS: *weekly_eis_model_groups
        timeout_in_minutes: 60
        agents:
          image: family/kibana-ubuntu-2404
          imageProject: elastic-images-prod
          provider: gcp
          machineType: n2-standard-8
          preemptible: true
        retry:
          automatic:
            - exit_status: '-1'
              limit: 3

      - label: 'Evals: Streams'
        key: kbn-evals-weekly-streams
        command: bash .buildkite/scripts/steps/evals/run_suite.sh
        env:
          KBN_EVALS: '1'
          FTR_EIS_CCM: '1'
          EVAL_SUITE_ID: 'streams'
          EVAL_FANOUT: '1'
          EVAL_INCLUDE_EIS_MODELS: '1'
          EVAL_MODEL_GROUPS: *weekly_eis_model_groups
        timeout_in_minutes: 60
        agents:
          image: family/kibana-ubuntu-2404
          imageProject: elastic-images-prod
          provider: gcp
          machineType: n2-standard-8
          preemptible: true
        retry:
          automatic:
            - exit_status: '-1'
              limit: 3

      - label: 'Evals: LLM Tasks'
        key: kbn-evals-weekly-llm-tasks
        command: bash .buildkite/scripts/steps/evals/run_suite.sh
        env:
          KBN_EVALS: '1'
          FTR_EIS_CCM: '1'
          EVAL_SUITE_ID: 'llm-tasks'
          EVAL_FANOUT: '1'
          EVAL_INCLUDE_EIS_MODELS: '1'
          EVAL_MODEL_GROUPS: *weekly_eis_model_groups
        timeout_in_minutes: 60
        agents:
          image: family/kibana-ubuntu-2404
          imageProject: elastic-images-prod
          provider: gcp
          machineType: n2-standard-8
          preemptible: true
        retry:
          automatic:
            - exit_status: '-1'
              limit: 3
      - label: 'Evals: Observability AI Insights'
        key: kbn-evals-weekly-obs-ai-assistant-ai-insights
        command: bash .buildkite/scripts/steps/evals/run_suite.sh
        env:
          KBN_EVALS: '1'
          FTR_EIS_CCM: '1'
          EVAL_SUITE_ID: 'obs-ai-assistant/ai_insights'
          EVAL_FANOUT: '1'
          EVAL_INCLUDE_EIS_MODELS: '1'
          EVAL_MODEL_GROUPS: *weekly_eis_model_groups
        timeout_in_minutes: 60
        agents:
          image: family/kibana-ubuntu-2404
          imageProject: elastic-images-prod
          provider: gcp
          machineType: n2-standard-8
          preemptible: true
        retry:
          automatic:
            - exit_status: '-1'
              limit: 3
